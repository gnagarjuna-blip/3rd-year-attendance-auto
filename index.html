<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: sans-serif; }
        .sticky-header { position: sticky; top: 0; background: white; z-index: 1000; border-bottom: 4px solid #007bff; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .roll-row { background: white; margin-bottom: 8px; border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #dee2e6; transition: 0.3s; }
        
        /* Status Colors */
        .status-present { border-left-color: #198754 !important; background: #e8f5e9; }
        .status-absent { border-left-color: #dc3545 !important; background: #fbe9e7; }
        
        .btn-group-sm .btn { width: 75px; font-weight: bold; }
        .stats-box { background: #e7f1ff; border-radius: 8px; padding: 8px; font-size: 0.85rem; }
        .diff-view { background: #fff3cd; border: 1px dashed #ffc107; border-radius: 5px; padding: 8px; margin-top: 10px; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="container p-0">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="m-0 fw-bold text-primary">Attendance Portal</h6>
            <button class="btn btn-success btn-sm fw-bold" onclick="sendWhatsApp()">POST TO WHATSAPP</button>
        </div>

        <div class="row g-2 mb-2">
            <div class="col-4">
                <label class="small fw-bold">Period</label>
                <select id="period-select" class="form-select form-select-sm" onchange="syncTimetable()">
                    <option value="0">P-I (9:20)</option>
                    <option value="1">P-II (10:10)</option>
                    <option value="2">P-III (11:10)</option>
                    <option value="3">P-IV (12:00)</option>
                    <option value="4">P-V (1:30)</option>
                    <option value="5">P-VI (2:20)</option>
                    <option value="6">P-VII (3:10)</option>
                </select>
            </div>
            <div class="col-4">
                <label class="small fw-bold">Subject</label>
                <select id="subject-select" class="form-select form-select-sm" onchange="syncFaculty()">
                    </select>
            </div>
            <div class="col-4">
                <label class="small fw-bold">Faculty</label>
                <select id="faculty-select" class="form-select form-select-sm">
                    </select>
            </div>
        </div>

        <div class="stats-box d-flex justify-content-around text-center">
            <div>Total: <br><b id="cnt-total">32</b></div>
            <div class="text-success">Present: <br><b id="cnt-pres">0</b></div>
            <div class="text-danger">Absent: <br><b id="cnt-abs">0</b></div>
            <div class="text-muted">Pending: <br><b id="cnt-pend">32</b></div>
        </div>

        <div class="mt-2">
            <input type="text" id="prev-abs-input" class="form-control form-control-sm" placeholder="Paste previous absentees to compare..." oninput="compareHourly()">
            <div id="diff-output" class="diff-view"></div>
        </div>
    </div>
</div>

<div class="container mt-3 pb-5">
    <div id="roll-list-container">
        </div>
</div>

<script>
    const rollNumbers = [
        "23E11A0201", "23E11A0202", "23E11A0204", "23E11A0205", "23E11A0207",
        "24E15A0201", "24E15A0202", "24E15A0203", "24E15A0204", "24E15A0205",
        "24E15A0206", "24E15A0207", "24E15A0208", "24E15A0209", "24E15A0210",
        "24E15A0212", "24E15A0213", "24E15A0214", "24E15A0215", "24E15A0216",
        "24E15A0217", "24E15A0218", "24E15A0219", "24E15A0220", "24E15A0221",
        "24E15A0222", "24E15A0223", "24E15A0224", "24E15A0225", "24E15A0226",
        "24E15A0227", "24E15A0228"
    ];

    // Timetable Mapping based on images
    const timetable = {
        'MON': ['WSES', 'DSP', 'PSP', 'PSOC', 'FIOT', 'Aptitude', 'Bridge Class'],
        'TUE': ['PSP', 'WSES', 'FIOT', 'DSP', 'Mini Project', 'Mini Project', 'Bridge Class'],
        'WED': ['FIOT', 'WSES', 'DSP', 'PSOC', 'Mini Project', 'Mini Project', 'Remedial Class'],
        'THU': ['PSOC', 'PSP', 'Control Systems Lab', 'Control Systems Lab', 'ES', 'HRT', 'Remedial Class'],
        'FRI': ['PSOC', 'DSP', 'Digital Signal Processing Lab', 'Digital Signal Processing Lab', 'ES', 'WSES', 'Remedial Class'],
        'SAT': ['FIOT', 'PSP', 'Power System Lab', 'Power System Lab', 'ES', 'Communication skills', 'Gate Class']
    };

    // Faculty Mapping (Update these names as per your department)
    const facultyMap = {
        'Mini Project': ['Dr. Harsh Wardhan Pandey'],
        'DSP': ['Prof. Ramu'],
        'WSES': ['Dr. S. Kumar'],
        'PSP': ['Prof. Anitha'],
        'PSOC': ['Dr. V. Rao'],
        'FIOT': ['Prof. Srinivas'],
        'Control Systems Lab': ['Lab Team'],
        'Digital Signal Processing Lab': ['Lab Team'],
        'Power System Lab': ['Lab Team'],
        'Aptitude': ['Training Cell'],
        'Bridge Class': ['Bridge Coordinator'],
        'Remedial Class': ['Subject Faculty'],
        'ES': ['Prof. Lakshmi'],
        'HRT': ['Prof. Kiran'],
        'Communication skills': ['English Dept'],
        'Gate Class': ['Gate Coordinator']
    };

    let attendanceData = {}; // Stores roll: 'P' or 'A'

    function init() {
        // Load All Subjects into dropdown once
        const subSelect = document.getElementById('subject-select');
        const allSubs = [...new Set(Object.values(timetable).flat())];
        allSubs.forEach(s => subSelect.innerHTML += `<option value="${s}">${s}</option>`);

        // Load Roll Numbers
        const container = document.getElementById('roll-list-container');
        rollNumbers.forEach(roll => {
            const div = document.createElement('div');
            div.className = 'roll-row shadow-sm';
            div.id = `row-${roll}`;
            div.innerHTML = `
                <span class="fw-bold">${roll}</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success" onclick="mark('${roll}', 'P')">P</button>
                    <button class="btn btn-outline-danger" onclick="mark('${roll}', 'A')">A</button>
                </div>
            `;
            container.appendChild(div);
        });
        syncTimetable();
    }

    function syncTimetable() {
        const day = ['SUN','MON','TUE','WED','THU','FRI','SAT'][new Date().getDay()];
        const pIdx = document.getElementById('period-select').value;
        const sub = (timetable[day]) ? timetable[day][pIdx] : "Extra Class";
        
        document.getElementById('subject-select').value = sub;
        syncFaculty();
    }

    function syncFaculty() {
        const sub = document.getElementById('subject-select').value;
        const facSelect = document.getElementById('faculty-select');
        facSelect.innerHTML = "";
        
        const facultyList = facultyMap[sub] || ["General Faculty"];
        facultyList.forEach(f => facSelect.innerHTML += `<option value="${f}">${f}</option>`);
    }

    function mark(roll, status) {
        attendanceData[roll] = status;
        const row = document.getElementById(`row-${roll}`);
        const buttons = row.querySelectorAll('button');
        
        row.classList.remove('status-present', 'status-absent');
        buttons[0].className = 'btn btn-outline-success';
        buttons[1].className = 'btn btn-outline-danger';

        if(status === 'P') {
            row.classList.add('status-present');
            buttons[0].className = 'btn btn-success';
        } else {
            row.classList.add('status-absent');
            buttons[1].className = 'btn btn-danger';
        }
        updateCounters();
        compareHourly();
    }

    function updateCounters() {
        const vals = Object.values(attendanceData);
        const pCount = vals.filter(v => v === 'P').length;
        const aCount = vals.filter(v => v === 'A').length;
        
        document.getElementById('cnt-pres').innerText = pCount;
        document.getElementById('cnt-abs').innerText = aCount;
        document.getElementById('cnt-pend').innerText = rollNumbers.length - (pCount + aCount);
    }

    function compareHourly() {
        const input = document.getElementById('prev-abs-input').value;
        const output = document.getElementById('diff-output');
        if(!input) { output.style.display = "none"; return; }

        const prevList = input.split(/[ ,]+/).filter(x => x.trim().length > 0);
        const currentAbs = Object.keys(attendanceData).filter(k => attendanceData[k] === 'A');

        const newlyAbsent = currentAbs.filter(x => !prevList.includes(x));
        const nowPresent = prevList.filter(x => attendanceData[x] === 'P');

        output.style.display = "block";
        output.innerHTML = `<b>Comparison:</b><br>` +
            (newlyAbsent.length ? `‚ùå New Absentees: ${newlyAbsent.join(", ")}<br>` : "") +
            (nowPresent.length ? `‚úÖ Now Present: ${nowPresent.join(", ")}` : "");
    }

    function sendWhatsApp() {
        const pLabel = document.getElementById('period-select').options[document.getElementById('period-select').selectedIndex].text;
        const sub = document.getElementById('subject-select').value;
        const fac = document.getElementById('faculty-select').value;
        const absList = Object.keys(attendanceData).filter(k => attendanceData[k] === 'A').sort().join(", ") || "NIL";
        
        const msg = `*üìå ATTENDANCE REPORT (G.NAGARJUNA_Class Incharge)*\n` +
                    `*Period:* ${pLabel}\n` +
                    `*Subject:* ${sub}\n` +
                    `*Faculty:* ${fac}\n` +
                    `--------------------------\n` +
                    `*‚úÖ Present:* ${document.getElementById('cnt-pres').innerText}\n` +
                    `*‚ùå Absentees:* ${document.getElementById('cnt-abs').innerText}\n` +
                    `--------------------------\n` +
                    `*Roll Nos (Absentees):*\n${absList}\n` +
                    `--------------------------`;

        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    init();
</script>
</body>
</html>
