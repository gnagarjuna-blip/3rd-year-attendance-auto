<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bunker Tracking System</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .sticky-header { position: sticky; top: 0; background: white; z-index: 1000; border-bottom: 5px solid #0056b3; padding: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .boy-text { color: #0056b3; font-weight: bold; } 
        .girl-text { color: #d63384; font-weight: bold; } 
        
        .roll-card { background: white; margin-bottom: 8px; border-radius: 12px; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #adb5bd; }
        .marked-present { border-left-color: #198754; background: #e9f7ef; }
        .marked-absent { border-left-color: #dc3545; background: #fdf2f2; }
        
        .stats-badge { font-size: 0.8rem; padding: 6px; border-radius: 8px; font-weight: bold; flex: 1; text-align: center; }
        .auto-diff-box { background: #fff3cd; border: 1px solid #ffe69c; padding: 8px; font-size: 0.75rem; margin-top: 10px; border-radius: 8px; color: #856404; }
        .summary-card { background: #e7f1ff; border: 1px solid #b3d7ff; border-radius: 10px; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="container p-0">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h6 class="mb-0 fw-bold text-dark">G.NAGARJUNA (CLASS INCHARGE)</h6>
                <small class="text-muted" id="current-day-display"></small>
            </div>
            <button class="btn btn-success btn-sm fw-bold px-3 shadow-sm" onclick="sendToWhatsApp()">POST REPORT</button>
        </div>

        <div class="row g-2 mb-2">
            <div class="col-4">
                <select id="period-sel" class="form-select form-select-sm fw-bold" onchange="syncClassInfo()">
                    <option value="0">P-I (9:20)</option>
                    <option value="1">P-II (10:10)</option>
                    <option value="2">P-III (11:10)</option>
                    <option value="3">P-IV (12:00)</option>
                    <option value="4">P-V (1:30)</option>
                    <option value="5">P-VI (2:20)</option>
                    <option value="6">P-VII (3:10)</option>
                </select>
            </div>
            <div id="class-info-display" class="col-8 form-control form-control-sm bg-light fw-bold text-truncate" style="font-size: 0.7rem;">Loading...</div>
        </div>

        <div class="d-flex gap-2">
            <div class="stats-badge bg-success text-white">Present: <span id="p-count">32</span></div>
            <div class="stats-badge bg-danger text-white">Absent: <span id="a-count">0</span></div>
            <div class="stats-badge bg-warning text-dark">Bunkers: <span id="b-count">0</span></div>
        </div>

        <div id="auto-diff-container" class="auto-diff-box" style="display: none;">
            <div id="diff-content">Comparing with previous hour...</div>
        </div>
    </div>
</div>

<div class="container mt-3 pb-5">
    <div id="student-list"></div>
    
    <div id="final-report-section" class="summary-card" style="display: none;">
        <h6 class="fw-bold text-primary">Day Summary (Partial Absentees)</h6>
        <div id="summary-content" class="small"></div>
        <button class="btn btn-primary btn-sm w-100 mt-2 fw-bold" onclick="shareFinalReport()">SHARE DAILY SUMMARY</button>
    </div>
</div>

<script>
    const students = [
        { r: "23E11A0201", n: "BASIUDEM ARJUN REDDY", g: "B" }, { r: "23E11A0202", n: "K RAJKUMAR", g: "B" },
        { r: "23E11A0204", n: "KUTHATI DHANYA", g: "B" }, { r: "23E11A0205", n: "PANTAHNGI NAVYA", g: "G" },
        { r: "23E11A0207", n: "KUNTIGORLA RAKESH", g: "B" }, { r: "24E15A0201", n: "A VAISHNAVI", g: "G" },
        { r: "24E15A0202", n: "A.RAKESH VERMA", g: "B" }, { r: "24E15A0203", n: "ALIVELI KARTHIK KUMAR", g: "B" },
        { r: "24E15A0204", n: "B.HARSHITHA", g: "G" }, { r: "24E15A0205", n: "BODRAMANI SAI KIRAN", g: "B" },
        { r: "24E15A0206", n: "D BHARATHCHANDRA", g: "B" }, { r: "24E15A0207", n: "D.SHAILAJA", g: "G" },
        { r: "24E15A0208", n: "DEVASATH RISHI KUMAR", g: "B" }, { r: "24E15A0209", n: "G.SAI KUMAR", g: "B" },
        { r: "24E15A0210", n: "GUGULOTHU SAI KUMAR", g: "B" }, { r: "24E15A0212", n: "KONDURU NITHIN", g: "B" },
        { r: "24E15A0213", n: "M BHASKAR", g: "B" }, { r: "24E15A0214", n: "M GANESH", g: "B" },
        { r: "24E15A0215", n: "M.GOWTHAMI", g: "G" }, { r: "24E15A0216", n: "MANDRA SHIVAMANI", g: "B" },
        { r: "24E15A0217", n: "MARAM AJAY", g: "B" }, { r: "24E15A0218", n: "N MUKESH", g: "B" },
        { r: "24E15A0219", n: "O.GAMANA", g: "G" }, { r: "24E15A0220", n: "P.VARSHA", g: "G" },
        { r: "24E15A0221", n: "R SPROOTHIKA", g: "G" }, { r: "24E15A0222", n: "RAMAVATH SAIRAM", g: "B" },
        { r: "24E15A0223", n: "RATHOD SHRUTHI", g: "G" }, { r: "24E15A0224", n: "SNEHA TAANK", g: "G" },
        { r: "24E15A0225", n: "THUMMALA SAI KUMAR", g: "B" }, { r: "24E15A0226", n: "VADLA SAI KRISHNA", g: "B" },
        { r: "24E15A0227", n: "VALLAPU KARTHIK YADAV", g: "B" }, { r: "24E15A0228", n: "V CHAKRAVARTHI VARMA", g: "B" }
    ];

    const facultyMap = {
        'FIOT': 'Mr. Praburaja Ramasamy', 'WSES': 'Mr. G. Nagarjuna', 'DSP': 'Mr. Muzammil Mushtaq',
        'PSP': 'Mrs. K Vani', 'PSOC': 'Dr. Praveen Tiwari', 'ES': 'Mrs. D. Swathi Devi',
        'Power System Laboratory': 'Dr. Harsh Wardhan Pandey', 'Control Systems Laboratory': 'Mr. Muzammil Mushtaq',
        'Digital Signal Processing Laboratory': 'Mr. Muzammil Mushtaq', 'Communication skills training': 'Dr. Nandu Parvathy',
        'Industrial Oriented Mini Project/Internship': 'Dr. Harsh Wardhan Pandey'
    };

    const timetable = {
        'MON': ['WSES', 'DSP', 'PSP', 'PSOC', 'FIOT', 'Aptitude', 'Bridge Class'],
        'TUE': ['PSP', 'WSES', 'FIOT', 'DSP', 'Industrial Oriented Mini Project/Internship', 'Industrial Oriented Mini Project/Internship', 'Bridge Class'],
        'WED': ['FIOT', 'WSES', 'DSP', 'PSOC', 'Industrial Oriented Mini Project/Internship', 'Industrial Oriented Mini Project/Internship', 'Remedial Class'],
        'THU': ['PSOC', 'PSP', 'Control Systems Laboratory', 'Control Systems Laboratory', 'ES', 'HRT', 'Remedial Class'],
        'FRI': ['PSOC', 'DSP', 'Digital Signal Processing Laboratory', 'Digital Signal Processing Laboratory', 'ES', 'WSES', 'Remedial Class'],
        'SAT': ['FIOT', 'PSP', 'Power System Laboratory', 'Power System Laboratory', 'ES', 'Communication skills training', 'Gate Class']
    };

    let attendance = {};
    let dayHistory = {}; // Format: { "Period_Label": [Absent Rolls] }
    let prevHourAbsentees = [];

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Load Day History from URL
        const historyData = urlParams.get('hist');
        if(historyData) {
            dayHistory = JSON.parse(decodeURIComponent(historyData));
            const periods = Object.keys(dayHistory);
            if(periods.length > 0) {
                prevHourAbsentees = dayHistory[periods[periods.length - 1]];
                document.getElementById('auto-diff-container').style.display = 'block';
                document.getElementById('final-report-section').style.display = 'block';
            }
        }

        const listDiv = document.getElementById('student-list');
        students.forEach(s => {
            attendance[s.r] = 'P';
            const colorClass = s.g === 'B' ? 'boy-text' : 'girl-text';
            const div = document.createElement('div');
            div.className = 'roll-card marked-present';
            div.id = `card-${s.r}`;
            div.innerHTML = `
                <div class="${colorClass}"><div>${s.r}</div><div style="font-size:0.7rem">${s.n}</div></div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-success btn-attendance" onclick="mark('${s.r}','P')">P</button>
                    <button class="btn btn-outline-danger btn-attendance" onclick="mark('${s.r}','A')">A</button>
                </div>`;
            listDiv.appendChild(div);
        });
        syncClassInfo();
        generateSummary();
    }

    function mark(roll, status) {
        attendance[roll] = status;
        const card = document.getElementById(`card-${roll}`);
        const btns = card.querySelectorAll('button');
        card.classList.remove('marked-present', 'marked-absent');
        btns[0].className = 'btn btn-outline-success btn-attendance';
        btns[1].className = 'btn btn-outline-danger btn-attendance';

        if(status === 'P') {
            card.classList.add('marked-present');
            btns[0].className = 'btn btn-success btn-attendance';
        } else {
            card.classList.add('marked-absent');
            btns[1].className = 'btn btn-danger btn-attendance';
        }
        updateStats();
    }

    function updateStats() {
        const currAbs = Object.keys(attendance).filter(k => attendance[k] === 'A');
        const newlyAbsent = currAbs.filter(x => !prevHourAbsentees.includes(x));
        const nowPresent = prevHourAbsentees.filter(x => attendance[x] === 'P');

        document.getElementById('a-count').innerText = currAbs.length;
        document.getElementById('p-count').innerText = 32 - currAbs.length;
        document.getElementById('b-count').innerText = newlyAbsent.length;

        if(prevHourAbsentees.length > 0) {
            let diffHtml = "";
            if(newlyAbsent.length) diffHtml += `‚ö†Ô∏è <b>Bunked this hour:</b> ${newlyAbsent.join(", ")}<br>`;
            if(nowPresent.length) diffHtml += `‚úÖ <b>Newly Joined:</b> ${nowPresent.join(", ")}`;
            document.getElementById('diff-content').innerHTML = diffHtml || "No status changes from last hour.";
        }
    }

    function generateSummary() {
        const bunkerMap = {};
        const allRolls = students.map(s => s.r);
        
        allRolls.forEach(roll => {
            const missedPeriods = [];
            Object.keys(dayHistory).forEach(p => {
                if(dayHistory[p].includes(roll)) missedPeriods.push(p);
            });
            if(missedPeriods.length > 0 && missedPeriods.length < Object.keys(dayHistory).length + 1) {
                bunkerMap[roll] = missedPeriods;
            }
        });

        let summaryHtml = "";
        Object.keys(bunkerMap).forEach(roll => {
            summaryHtml += `‚Ä¢ <b>${roll}</b>: Missed ${bunkerMap[roll].join(", ")}<br>`;
        });
        document.getElementById('summary-content').innerHTML = summaryHtml || "All students are attending all classes consistently.";
    }

    function syncClassInfo() {
        const d = ['SUN','MON','TUE','WED','THU','FRI','SAT'][new Date().getDay()];
        const p = document.getElementById('period-sel').value;
        const sub = timetable[d] ? timetable[d][p] : "Special Class";
        document.getElementById('class-info-display').innerText = `${sub} - ${facultyMap[sub] || 'Dept Faculty'}`;
        document.getElementById('current-day-display').innerText = `${d}, ${new Date().toLocaleDateString()}`;
    }

    function sendToWhatsApp() {
        const periodLabel = document.getElementById('period-sel').options[document.getElementById('period-sel').selectedIndex].text.split(' ')[0];
        const absList = Object.keys(attendance).filter(k => attendance[k] === 'A').sort();
        
        // Update History for URL
        const updatedHistory = {...dayHistory};
        updatedHistory[periodLabel] = absList;
        const histString = encodeURIComponent(JSON.stringify(updatedHistory));
        const trackingLink = `${window.location.href.split('?')[0]}?hist=${histString}`;

        const newlyAbsent = absList.filter(x => !prevHourAbsentees.includes(x));

        const msg = `*üìä ATTENDANCE REPORT (G.NAGARJUNA_CLASS_IC)*\n` +
                    `*Period:* ${periodLabel}\n` +
                    `*Class:* ${document.getElementById('class-info-display').innerText}\n` +
                    `--------------------------\n` +
                    `*‚úÖ Present:* ${document.getElementById('p-count').innerText}\n` +
                    `*‚ùå Absent:* ${document.getElementById('a-count').innerText}\n` +
                    `--------------------------\n` +
                    `*Newly Absent (Bunked):* ${newlyAbsent.join(", ") || "NIL"}\n` +
                    `*Total Absentees:* ${absList.join(", ") || "NIL"}\n\n` +
                    `*üîó NEXT FACULTY CLICK HERE:* \n${trackingLink}`;

        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function shareFinalReport() {
        const summary = document.getElementById('summary-content').innerText;
        const msg = `*üèÅ END-OF-DAY ATTENDANCE SUMMARY*\n` +
                    `*Class Incharge: G. NAGARJUNA*\n` +
                    `--------------------------\n` +
                    `*Irregular Student Tracking:*\n${summary}\n` +
                    `--------------------------\n` +
                    `_Generated via Faculty Attendance Pro_`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    init();
</script>
</body>
</html>
